% tartan: A package to typeset Scottish Country Dance ball programs
%
% Copyright 2017 Jonathan Lovelace
% 
% This file may be distributed and/or modified under the conditions of the
% LaTeX Project Public License, either version 1.3c of this license or (at your
% option) any later version. The latest version of this license is in:
%
% http://www.latex-project.org/lppl.txt
%
% and version 1.3c or later is part of all ditributions of LaTeX version
% 2008/05/04 or later.
%
% Maintainer: Jonathan Lovelace
% Website:    https://shinecycle.wordpress.com
% Contact:    kingjon3377@gmail.com
%
% This work consists of this file, tartan.tex, and the sample document, example.tex.

\usepackage{xstring}
\usepackage{etoolbox}
\usepackage{makecell}
\usepackage{relsize}
\usepackage{tocloft}
\usepackage{environ}
\usepackage{parskip}

\usepackage{longtable}
\usepackage{tabu}

% By default LaTeX prints a page number on every page; we hereby turn that feature off.
\pagestyle{empty}
\addtocontents{dances}{\protect\thispagestyle{empty}}

% This is the boilerplate to set up the list of dances/table of contents.
% It causes a \listofdances command to be created, which will typeset the table
% of contents.
% You'll want to put \clearpage (or \cleardoublepage) before and after \listofdances.
% TODO: Fix the unwanted hard space at the right of each contents line
\newlistof{dances}{dances}{\relax}
\cftpagenumbersoff{dances}

% Add a dance to the program. The parameters to \begin{scdance} are as follows:
% 1. The title or name of the dance.
% 2. The source of the dance.
% 3. The tempo of the dance: Jig, Reel, Strathspey, or Medley.
% 4. The length of the dance: RxB, where R is the number of times through the
%    dance and B is the length of each round in bars of music.
% 5. The formation in which the dance is danced: "2C (4C set)", "Sq. Set", "3C set", etc.
% TODO: Add to a "list of dances" that will be handled like a table of contents.
% TODO: Allow user to control whether source is printed with the dance directions.
% TODO: Provide an easier way to read dance directions from file
% TODO: allow a dance to be split onto multiple pages
\NewEnviron{scdance}[5]{\par \noindent \refstepcounter{dances}\textbf{\large \uppercase{#1}\addcontentsline{dances}{dances}{\protect\numberline{\thedances}\textbf{#1}\protect\hfill#3\ifstrempty{#2}{\relax}{, #2}}\hfill(\StrLeft{#3}{1}#4) #5}\ifstrempty{#2}{\relax}{\\*\textit{#2}}\begin{longtabu} { lX } \BODY \end{longtabu}}
%\newenvironment{scdance}[5]{\par \noindent \refstepcounter{dances}\textbf{\large \uppercase{#1}\addcontentsline{dances}{dances}{\protect\numberline{\thedances}\textbf{#1}\protect\hfill#3\ifstrempty{#2}{\relax}{, #2}}\hfill(\StrLeft{#3}{1}#4) #5}\\*\ifstrempty{#2}{\relax}{\textit{#2}\\*}\tabularx{\linewidth}{ lX }}{\endtabularx}

% Add a (dance) figure to the current dance. It takes the bar(s) this line of
% the directions describes as an optional parameter, and the movement as the
% required parameter. Should only be used inside an scdance environment (though
% it can be used inside a namedfigure environment, as defined below).
\newcommand{\scfigure}[2][\relax]{#1 & #2 \tabularnewline}

% Typeset a series of (dance) figures indented from the main directions, as in
% the case of a complicated named figure (e.g. the Targe) or a meanwhile
% figure. Should only be used inside an scdance environment (but can also be
% nested inside itself if needed).
% FIXME: Figure out why making this an environment, as in the commented-out
% code, results in a "Missing \endgroup inserted." error.
% FIXME: Figure out why making this a 'longtabu' environment instead of 'tabu'
% results in a "Forbidden control sequence found" error.
\newcommand{\namedfigure}[1]{& \begin{tabu}{ l X } \smaller #1 \larger \end{tabu} \tabularnewline}
%\newcommand{\namedfigure}[1]{& \restoretx\begin{tabularx}{\linewidth}{ lX } \smaller #1 \larger \end{tabularx} \unrestoretx\tabularnewline}
%\newenvironment{namedfigure}{& \tabularx{\linewidth}{ lX }\smaller}{\larger \endtabularx \tabularnewline}

% Add a break or intermission to the list of dances. It will *not* be printed
% between the dances' directions, but only in the table of contents. It takes
% what to call the intermission as its sole argument (in *square* brackets);
% this can be omitted, in which case it defaults to "Intermission".
\newcommand{\intermission}[1][Intermission]{\addtocontents{dances}{\protect\contentsline{dances}{\hfill \textbf{#1}}{}}\relax}
